<!DOCTYPE html>
<html>
<head><title>Image Decorator</title></head>
<body>
  <canvas id="canvas" style="display:none;"></canvas>
  <script>
    // อ่าน parameter URL
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    async function main() {
      const imageUrl = getQueryParam("URLimage");
      const priceText = getQueryParam("priceText") || "59.-";
      if (!imageUrl) {
        alert("กรุณาระบุพารามิเตอร์ URLimage");
        return;
      }

      // โหลดภาพและตกแต่ง
      const img = new Image();
      img.crossOrigin = "Anonymous";
      img.src = imageUrl;

      img.onload = async () => {
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");

        // กำหนดขนาด canvas ตามภาพ (ปรับขนาดตามต้องการ)
        const desiredWidth = 800;
        const scaleFactor = desiredWidth / img.width;
        const newWidth = desiredWidth;
        const newHeight = img.height * scaleFactor;

        canvas.width = newWidth;
        canvas.height = newHeight;

        ctx.drawImage(img, 0, 0, newWidth, newHeight);

        // กรอบแดง
        ctx.lineWidth = 10;
        ctx.strokeStyle = "red";
        ctx.strokeRect(0, 0, newWidth, newHeight);

        // กล่องดำ
        const boxWidth = 100;
        const boxHeight = 50;
        const padding = 20;
        ctx.fillStyle = "black";
        ctx.fillRect(newWidth - boxWidth - padding, newHeight - boxHeight - padding, boxWidth, boxHeight);

        // ข้อความราคา
        ctx.fillStyle = "yellow";
        ctx.font = "bold 24px sans-serif";
        ctx.fillText(priceText, newWidth - boxWidth + 10 - padding, newHeight - 20);

        // แปลงเป็น data URL
        const dataUrl = canvas.toDataURL("image/jpeg");

        // ส่งไป Google Apps Script
        const response = await fetch("https://script.google.com/macros/s/AKfycbyTCEz9MjHno_yLgI1IaNOQJQVTBiUEmUtOh8Oe66bVRbHXiogfEdQ-FTeSSShim2laVQ/exec", {
          method: "POST",
          body: JSON.stringify({ dataUrl, priceText }),
          headers: { "Content-Type": "application/json" }
        });
        const result = await response.json();
        if (result.status === "success") {
          alert("บันทึกไฟล์เรียบร้อย! URL: " + result.url);
          // แสดงหรือเก็บ URL ตามต้องการ
        } else {
          alert("ผิดพลาด: " + result.message);
        }
      };

      img.onerror = () => alert("โหลดภาพไม่ได้");
    }

    main();
  </script>
</body>
</html>
